generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Message {
  id            String   @id @default(cuid())
  category      String   // EVENT_TRACK, MESSAGE, AUTHENTICATION, MOCK_API, GENERAL
  provider      String?  // "snowplow", "email", "sms", etc.
  sourceUrl     String   // URL path của request
  method        String   // GET, POST, PUT, DELETE, etc.
  headers       String   // JSON string của headers
  body          String?  // JSON string của body
  queryParams   String?  // JSON string của query params
  statusCode    Int?     // Response status code
  responseBody  String?  // Response body nếu có
  errorMessage  String?  // Error message nếu có
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  processedAt   DateTime? // Khi message được xử lý
  
  // Forwarding fields
  forwarded        Boolean   @default(false)
  forwardConfigId  String?
  forwardConfig    ForwardConfig? @relation(fields: [forwardConfigId], references: [id])
  forwardTarget    String?   // Actual URL that was forwarded to
  forwardStatus    String?   // "SUCCESS", "FAILED", "TIMEOUT", "ERROR"
  forwardError     String?   // Error message if forward failed
  
  // Performance fields
  responseTime     Int?      // Response time in milliseconds
  responseSize     Int?      // Response body size in bytes
  requestSize      Int?      // Request body size in bytes
  responseHeaders  String?   // JSON string of response headers
  
  // Replay fields
  replayCount      Int       @default(0)
  lastReplayedAt   DateTime?
  lastReplayStatus String?   // "SUCCESS", "FAILED"
  
  // Relations
  replayHistories  ReplayHistory[]
  
  @@index([category])
  @@index([provider])
  @@index([createdAt])
  @@index([category, createdAt])
  @@index([forwarded])
  @@index([forwardConfigId])
  @@index([forwardStatus])
  @@index([responseTime])
  @@map("messages")
}

model PurgeConfig {
  id              String   @id @default(cuid())
  category        String   @unique // EVENT_TRACK, MESSAGE, AUTHENTICATION, GENERAL
  maxMessages     Int      @default(500)
  lastPurgedAt    DateTime?
  
  @@map("purge_config")
}

model ErrorLog {
  id            String   @id @default(cuid())
  level         String   // ERROR, WARN, INFO
  source        String   // API route, component, etc.
  message       String   // Error message
  stack         String?  // Stack trace
  context       String?  // JSON string of additional context
  requestUrl    String?  // Request URL if applicable
  requestMethod String?  // Request method if applicable
  requestHeaders String? // Request headers if applicable
  requestBody   String?  // Request body if applicable
  responseStatus Int?    // Response status code if applicable
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  
  @@index([level])
  @@index([source])
  @@index([createdAt])
  @@index([level, createdAt])
  @@map("error_logs")
}

model MockEndpoint {
  id              String   @id @default(cuid())
  path            String   // e.g., "/api/users/:id"
  method          String   // GET, POST, PUT, DELETE, etc.
  name            String?  // Tên mô tả endpoint
  description     String?  // Mô tả chi tiết
  responseCode    Int      @default(200) // HTTP status code
  responseBody    String   // JavaScript code để execute
  responseHeaders String?  // JSON string của headers
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Quan hệ với requests đã gọi tới endpoint này
  requests        MockRequest[]
  
  @@unique([path, method])
  @@index([path])
  @@index([method])
  @@index([isActive])
  @@map("mock_endpoints")
}

model MockRequest {
  id              String   @id @default(cuid())
  mockEndpointId  String
  mockEndpoint    MockEndpoint @relation(fields: [mockEndpointId], references: [id], onDelete: Cascade)
  headers         String   // JSON string của headers
  body            String?  // JSON string của body
  queryParams     String?  // JSON string của query params
  pathParams      String?  // JSON string của path params (e.g., {id: "123"})
  responseCode    Int      // Response code đã trả về
  responseBody    String?  // Response body đã trả về
  responseHeaders String?  // Response headers đã trả về
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())
  
  @@index([mockEndpointId])
  @@index([createdAt])
  @@map("mock_requests")
}

model ForwardConfig {
  id            String   @id @default(cuid())
  
  // Proxy path (what client sends)
  proxyPath     String   // "/api/proxy/snowplow/track" hoặc "/api/proxy/snowplow/*"
  method        String   // "POST", "GET", "PUT", "DELETE", "PATCH"
  
  // Target configuration
  targetUrl     String   // "https://real-server.com/api/endpoint" hoặc "https://real-server.com/api/:path"
  pathRewrite   String?  // Pattern để rewrite path (optional), e.g., "/track" để remove proxy prefix
  
  // Headers transformation (optional)
  addHeaders    String?  // JSON: {"Authorization": "Bearer xxx", "X-Custom-Header": "value"}
  removeHeaders String?  // JSON array: ["X-Forwarded-For", "X-Real-IP"]
  
  // Authentication & Chaining
  extractTokenFrom String?  // "body" | "headers" - Where to extract token from
  tokenPath       String?   // JSON path to extract token, e.g., "$.token" or "$.data.accessToken"
  tokenHeaderName String?   // Header name to add token to, e.g., "Authorization"
  nextForwardConfigId String? // ID of next forward config to chain to
  
  // Options
  enabled       Boolean  @default(true)
  timeout       Int      @default(30000) // milliseconds
  retryCount    Int      @default(0)     // Number of retries on failure
  retryDelay    Int      @default(1000)  // Delay between retries (milliseconds)
  
  // Metadata
  name          String?  // Human-readable name, e.g., "Snowplow Event Tracking"
  description   String?  // Description of what this forward config does
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  forwardedMessages Message[] // Messages that used this config
  
  // Self-referential relation for chaining
  nextForwardConfig ForwardConfig? @relation("ForwardChain", fields: [nextForwardConfigId], references: [id], onDelete: SetNull)
  previousForwardConfigs ForwardConfig[] @relation("ForwardChain")
  
  @@unique([proxyPath, method])
  @@index([proxyPath])
  @@index([method])
  @@index([enabled])
  @@index([nextForwardConfigId])
  @@map("forward_configs")
}

model ReplayHistory {
  id            String   @id @default(cuid())
  messageId     String
  message       Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  // Replay details
  replayedAt    DateTime @default(now())
  targetUrl    String   // URL that was replayed to
  statusCode   Int?     // Response status code
  responseTime Int?     // Response time in milliseconds
  success      Boolean  // Whether replay was successful
  
  // Comparison với original
  originalStatusCode Int?
  originalResponseTime Int?
  responseDiff String?  // JSON diff between original and replay response
  
  // Error info
  errorMessage String?
  
  createdAt     DateTime @default(now())
  
  @@index([messageId])
  @@index([replayedAt])
  @@map("replay_histories")
}

